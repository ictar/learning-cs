目录
=================

   * [测试和性能](#测试和性能)
      * [单元测试](#单元测试)
         * [模仿调用](#模仿调用)
         * [测试服务端点（endpoint）](#测试服务端点endpoint)
      * [示例](#示例)
      * [基准测试](#基准测试)


# 测试和性能

## 单元测试
单元测试是用来测试包或者程序的一部分代码或者一组代码的函数。测试的目的是确认目标代码在给定的场景下，有没有按照期望工作。
* 一个场景是正向路经测试，就是在正常执行的情况下，保证代码不产生错误的测试。
* 另外一些单元测试可能会测试负向路径的场景，保证代码不仅会产生错误，而且是预期的错误。

在Go语言里有几种方法写单元测试：
* **基础测试（basic test）**只使用一组参数和结果来测试一段代码。
* **表组测试（table test）**也会测试一段代码，但是会使用多组参数和结果进行测试。
* 也可以使用一些方法来模仿（mock）测试代码需要使用到的外部资源，如数据库或者网络服务器。
  * 这有助于让测试在没有所需的外部资源可用的时候，模拟这些资源的行为使测试正常进行。

Go语言的测试工具只会认为以_test.go结尾的文件是测试文件。如果没有遵从这个约定，在包里运行go test的时候就可能会报告没有测试文件。一旦测试工具找到了测试文件，就会查找里面的测试函数并执行。

```golang
// testing包提供了从测试框架到报告测试的输出和状态的各种测试功能的支持
import "testing"

// 一个测试函数必须是公开的函数，并且以Test单词开头。
// 不但函数名字要以Test开头，而且函数的签名必须接收一个指向testing.T类型的指针，并且不返回任何值。
// 如果没有遵守这些约定，测试框架就不会认为这个函数是一个测试函数，
// 也不会让测试工具去执行它。
func TestXXX(t *testing.T) {
    // ...
}
```

### 模仿调用
模仿（mocking）是一个很常用的技术手段，用来在运行测试时模拟访问不可用的资源。包 `httptest` 可以让你能够模仿互联网资源的请求和响应。

### 测试服务端点（endpoint）
**服务端点（endpoint）**是指与服务宿主信息无关，用来分辨某个服务的地址，一般是不包含宿主的一个路径。如果在构造网络API，你会希望直接测试自己的服务的所有服务端点，而不用启动整个网络服务。包httptest正好提供了做到这一点的机制。

如果包的名字以`_test`结尾，那么测试代码只能访问包里公开的标识符。即便测试代码文件和被测试的代码放在同一个文件夹中，也只能访问公开的标识符。

## 示例
godoc工具可以生成包的文档，它的另一个特性是**示例代码**。示例代码给文档和测试都增加了一个可以扩展的维度。

```golang
// 示例代码的函数名字必须基于已经存在的公开的函数或者方法。
// 示例代码的函数名字必须以 Example 开头
func ExampleXXXX() {
    // 写示例代码的目的是展示某个函数或者方法的特定使用方法。
    // 为了判断测试是成功还是失败，需要将程序最终的输出和示例函数底部列出的输出做比较
    // ...
    // Output:
    // ...
    // 这个Output:标记用来在文档中标记出示例函数运行后期望的输出。
    // Go的测试框架知道如何比较注释里的期望输出和标准输出的最终输出。
    // 如果两者匹配，这个示例作为测试就会通过，并加入到包的Go文档里。
    // 如果输出不匹配，这个示例作为测试就会失败。
}
```

## 基准测试
基准测试是一种测试代码性能的方法。想要测试解决同一问题的不同方案的性能，以及查看哪种解决方案的性能更好时，基准测试就会很有用。

和单元测试文件一样，基准测试的文件名也必须以_test.go结尾。同时也必须导入testing包。
```golang
import "testing"

// 基准测试函数必须以Benchmark开头，
// 接受一个指向testing.B类型的指针作为唯一参数。
// 基准测试框架默认会在持续1秒的时间内，反复调用需要测试的函数。
// 测试框架每次调用测试函数时，都会增加b.N的值。
// 第一次调用时，b.N的值为1。
func BenchmarkXXXX(b *testing.B) {
    // ...
    for i := 0; i < b.N; i++ {
        // 需要注意，一定要将所有要进行基准测试的代码都放到循环里，
        // 并且循环要使用b.N的值。否则，测试的结果是不可靠的。
    }
}
```

如果只希望运行基准测试函数，需要加入-bench选项：
```sh
# 给-run选项传递了字符串"none"，
# 来保证在运行制订的基准测试函数之前没有单元测试会运行
$ go test -v -run="none" -bench="BenchmarkXXXX"
# 如果想让运行时间更长，可以使用另一个名为-benchtime的选项来更改测试执行的最短时间。
# 另一个很有用的选项是-benchmem选项。这个选项可以提供每次操作分配内存的次数，以及总共分配内存的字节数。
```